# Домашняя работа по работе с блокировками

## Настройка параметров
Для отслеживания ожидания наложения блокировок более 200 милисекунд, были изменены следующие параметры  
log_lock_waits = on  
log_min_duration_statement = 200  

## Создание БД и таблицы
```SQL
CREATE DATABASE hcm
    WITH
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'Russian_Russia.1251'
    LC_CTYPE = 'Russian_Russia.1251'
    LOCALE_PROVIDER = 'libc'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1
    IS_TEMPLATE = False;
```

```SQL
CREATE TABLE IF NOT EXISTS public.personnel
(
    id integer NOT NULL DEFAULT nextval('personnel_id_seq'::regclass),
    fio character(100) COLLATE pg_catalog."default"
)

WITH (
    autovacuum_enabled = TRUE
)
TABLESPACE pg_default;
```

## Обновление одной записи в трёх разных сеансах
### Обновление в первой транзакции
```SQL
BEGIN;
UPDATE personnel SET fio = 'Steve Rogers' WHERE id = 100;
```
1. Возникает блокировка типа **relation** в режиме **RowExclusiveLock**. **Granted? = true**  
2. Возникает блокировка типа **transactionid** в режиме **ExclusiveLock**.  **Granted? = true** 

### Обновление во второй транзакции
```SQL
BEGIN;
UPDATE personnel SET fio = 'Steve Rogers2' WHERE id = 100;
```
1. Возникает блокировка типа **tuple** в режиме **ExclusiveLock**. **Granted? = true**
2. Возникает блокировка типа **relation** в режиме **RowExclusiveLock**. **Granted? = true**
3. Возникает блокировка типа **transactionid** в режиме **ExclusiveLock**. **Granted? = true**
4. Возникает блокировка типа **transactionid** в режиме **ShareLock**. **Granted? = false**

Наложены 3 из 4х возникших блокировок. Оператор UPDATE ещё не выполнился. В журнал попало сообщение об ожидании блокировки вторым процессом с указанием ID первого процесса и оператора из второго процесса. Ожидается блокировка в режиме **ShareLock**.

### Обновление в третьей транзакции
```SQL
BEGIN;
UPDATE personnel SET fio = 'Steve Rogers++' WHERE id = 100;
```
1. Возникает блокировка типа **tuple** в режиме **ExclusiveLock**. **Granted? = false**
2. Возникает блокировка типа **relation** в режиме **RowExclusiveLock**. **Granted? = true**
2. Возникает блокировка типа **transactionid** в режиме **ExclusiveLock**. **Granted? = true**

Наложены 2 блокировки. Оператор UPDATE тоже не выполнился. Блокировка с типом **transactionid** в режиме **ShareLock** ещё не создана. В журнал попало сообщение об ожидании блокировки третьим процессом с указанием ID второго процесса и оператора из терьего процесса. Ожидается блокировка в режиме **ExclusiveLock**.

### Коммит в первой транзакции
```SQL
COMMIT;
```
1. Выполняется оператор UPDATE во второй транзакции.
2. Остаются две блокировки из второй транзакции: типа **relation** в режиме **RowExclusiveLock** и типа **transactionid** в режиме **ExclusiveLock**. **Granted? = true**
3. Возникает блокировка в третьей транзакции типа **tuple** в режиме **ExclusiveLock**. **Granted? = true**.
4. Возникает блокировка в третьей транзакции типа **transactionid** в режиме **ShareLock**. **Granted? = false**.

Во второй транзакции остаются только две наложенные блокировки. В третьей накладывается одна ожидающая блокировка и ещё одна возникает. В журнале указано, что второй процесс получил блокировку в режиме **ShareLock**. Третий процесс получил блокировку в режиме **ExclusiveLock** и ожидает блокировку в режиме **ShareLock**.

### Коммит во второй транзакции
```SQL
COMMIT;
```
1. Выполняется оператор UPDATE в третьей транзакции.
2. Снимаются все блокировки из второго процесса.
3. Остаются две блокировки из третьего процесса: типа **relation** в режиме **RowExclusiveLock** и типа **transactionid** в режиме **ExclusiveLock**. **Granted? = true**

Остаются только две блокировки от третьего процесса. В журнале указано третий процесс получил блокировку в режиме **ShareLock**.

### Коммит в третьей транзакции
```SQL
COMMIT;
```
Снимаются последние блокировка. В журнал не добавляется никаких записей.

## Выводы
Журнал показывает подробную информацию по блокировкам с указанием ID блокирующих процессов. Понять кто кого заблокировал возможно.  

При попытке обновить запись возникает несколько блокировок и накладываются они последовательно. Блокировки типа **tuple** в режиме **ExclusiveLock** не мешают друг другу. Блокировки типа **tuple** в режиме **ExclusiveLock** не могут быть наложены одноверемнно на одну и ту же запись. 
1. Блокировка типа **transactionid** в режиме **ExclusiveLock** из первой транзакции не даёт наложится блокировке **transactionid** в режиме **ShareLock** во второй транзакции и не даёт выполнить обновление.
2. В третьей транзакции не удаётся наложить блокировку типа **tuple** в режиме **ExclusiveLock**. Из-за этого попытка наложить блокировку типа **transactionid** в режиме **ShareLock** даже не возникает.
3. После коммита в первой транзакции выполняется обновление во второй транзакции. В третьей транзакции возникает блокировка типа **transactionid** в режиме **ShareLock**, но она не может быть наложена из-за блокировки **transactionid** в режиме **ExclusiveLock** во второй транзакции.
4. После коммита во второй транзакции накладывается блокировка типа **transactionid** в режиме **ShareLock** в третьей транзакции.